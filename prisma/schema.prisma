// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["driverAdapters"]
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

enum Role {
  SUPER_ADMIN
  ADMIN
  MEMBER
}

enum PlanTier {
  STARTER
  GROWTH
  SCALE
  ENTERPRISE
}

enum Platform {
  META
  GOOGLE
}

enum InsightType {
  PERFORMANCE_ALERT
  OPTIMIZATION_OPPORTUNITY
  BUDGET_ALERT
  CREATIVE_IDEA
  AUDIENCE_RECOMMENDATION
}

enum InsightStatus {
  PENDING
  IN_PROGRESS
  RESOLVED
  DISMISSED
}

enum AIProviderType {
  OPENAI
  ANTHROPIC
  GOOGLE_GEMINI
  AZURE_OPENAI
}

model User {
  id             String         @id @default(cuid())
  email          String         @unique
  name           String?
  image          String?
  hashedPassword String?
  role           Role           @default(MEMBER)
  isSuperAdmin   Boolean        @default(false)
  agencyId       String?
  agency         Agency?        @relation(fields: [agencyId], references: [id])
  sessions       Session[]
  accounts       Account[]
  createdAt      DateTime       @default(now())
  updatedAt      DateTime       @updatedAt
  SystemConfig   SystemConfig[]
  invitations    Invitation[]
}

model Agency {
  id        String   @id @default(cuid())
  name      String
  timezone  String   @default("Asia/Kolkata")
  plan      PlanTier @default(STARTER)
  aiEnabled Boolean  @default(true)
  users     User[]
  clients   Client[]
  invitations Invitation[]
  settings  Json?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Client {
  id            String           @id @default(cuid())
  agencyId      String
  agency        Agency           @relation(fields: [agencyId], references: [id], onDelete: Cascade)
  name          String
  metaAccount   MetaAccount?
  googleAccount GoogleAccount?
  reports       Report[]
  insights      Insight[]
  metrics       CampaignMetric[]
  createdAt     DateTime         @default(now())
  updatedAt     DateTime         @updatedAt
}

model MetaAccount {
  id           String   @id @default(cuid())
  clientId     String   @unique
  client       Client   @relation(fields: [clientId], references: [id], onDelete: Cascade)
  accountId    String
  accessToken  String
  refreshToken String?
  tokenExpiry  DateTime
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
}

model GoogleAccount {
  id           String   @id @default(cuid())
  clientId     String   @unique
  client       Client   @relation(fields: [clientId], references: [id], onDelete: Cascade)
  customerId   String
  accessToken  String
  refreshToken String
  tokenExpiry  DateTime
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
}

model CampaignMetric {
  id          String   @id @default(cuid())
  clientId    String
  client      Client   @relation(fields: [clientId], references: [id], onDelete: Cascade)
  platform    Platform
  campaignId  String
  date        DateTime
  spend       Decimal
  impressions Int
  clicks      Int
  conversions Decimal
  roas        Decimal?
  cpa         Decimal?
  createdAt   DateTime @default(now())

  @@unique([clientId, platform, campaignId, date])
}

model Report {
  id          String    @id @default(cuid())
  clientId    String
  client      Client    @relation(fields: [clientId], references: [id], onDelete: Cascade)
  periodStart DateTime
  periodEnd   DateTime
  channelData Json
  summary     String
  reportHtml  String
  sentAt      DateTime?
  createdAt   DateTime  @default(now())
}

model Insight {
  id          String        @id @default(cuid())
  clientId    String
  client      Client        @relation(fields: [clientId], references: [id], onDelete: Cascade)
  type        InsightType
  payload     Json
  impactScore Int
  status      InsightStatus @default(PENDING)
  aiProvider  String?
  aiModel     String?
  createdAt   DateTime      @default(now())
  resolvedAt  DateTime?
}

model AIProvider {
  id        String         @id @default(cuid())
  name      String
  provider  AIProviderType
  apiKey    String
  model     String?
  projectId String?
  priority  Int            @default(0)
  isEnabled Boolean        @default(true)
  metadata  Json?
  createdAt DateTime       @default(now())
  updatedAt DateTime       @updatedAt
}

model PricingPlan {
  id           String   @id @default(cuid())
  tier         PlanTier @unique
  name         String
  description  String?
  priceMonthly Decimal
  priceYearly  Decimal?
  currency     String   @default("INR")
  billingInterval String @default("monthly")
  clientLimit  Int?
  userLimit    Int?
  aiCredits    Int?
  features     Json?
  isActive     Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
}

model SystemConfig {
  id          String   @id @default(cuid())
  key         String   @unique
  value       Json
  description String?
  updatedById String?
  updatedBy   User?    @relation(fields: [updatedById], references: [id])
  updatedAt   DateTime @default(now()) @updatedAt
}

model Invitation {
  id          String   @id @default(cuid())
  email       String
  role        Role     @default(MEMBER)
  agencyId    String
  agency      Agency   @relation(fields: [agencyId], references: [id], onDelete: Cascade)
  token       String   @unique
  expiresAt   DateTime
  acceptedAt  DateTime?
  invitedById String?
  invitedBy   User?    @relation(fields: [invitedById], references: [id])
  createdAt   DateTime @default(now())

  @@index([agencyId])
}

model Account {
  id                 String  @id @default(cuid())
  userId             String
  user               User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  type               String
  provider           String
  providerAccountId  String
  refresh_token      String?
  access_token       String?
  expires_at         Int?
  token_type         String?
  scope              String?
  id_token           String?
  session_state      String?
  oauth_token_secret String?
  oauth_token        String?

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  expires      DateTime
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}
